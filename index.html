<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Mall Directory</title>
    <!-- Using Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Using a custom font from Google Fonts */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom scrollbar for a more polished look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Style for the filter buttons */
        .filter-btn.active {
            background-color: #1D4ED8; /* a darker blue */
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header Section -->
        <header class="text-center mb-8 bg-white p-6 rounded-xl shadow-md">
            <h1 class="text-4xl font-bold text-gray-800">Mall Directory</h1>
            <p class="text-gray-500 mt-2">Find your favorite stores, restaurants, and services.</p>
        </header>

        <!-- Search and Filter Section -->
        <div class="search-and-filter mb-8 p-6 bg-white rounded-xl shadow-md sticky top-4 z-10">
            <div class="relative mb-4">
                <input type="text" id="search-input" placeholder="Search by name, category, or lot..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                <svg class="w-6 h-6 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
             <div class="space-y-4">
                <div id="floor-filters" class="flex flex-wrap gap-2 sm:gap-3 justify-center items-center">
                    <span class="font-semibold text-gray-600 mr-2 shrink-0">Floor:</span>
                    <!-- Floor filter buttons will be generated here -->
                </div>
                <div id="category-filters" class="flex flex-wrap gap-2 sm:gap-3 justify-center items-center border-t border-gray-200 pt-4">
                     <span class="font-semibold text-gray-600 mr-2 shrink-0">Category:</span>
                    <!-- Category buttons will be generated here -->
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center py-16">
            <p class="text-gray-500">Loading directory...</p>
        </div>

        <!-- Store Listings Section -->
        <div id="store-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 sm:gap-6 hidden">
            <!-- Store listings will be generated here by JavaScript -->
        </div>
        
        <!-- No Results Message -->
        <div id="no-results" class="hidden text-center py-16">
            <h3 class="text-2xl font-semibold text-gray-700">No Stores Found</h3>
            <p class="text-gray-500 mt-2">Try adjusting your search or filter criteria.</p>
        </div>

    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {

    // --- 1. LIVE DATA SOURCE ---
    // The original URL to your published Google Sheet.
    const originalUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQhb7qcusT6MFDWNQSU4g87l1djch87fwrTRTuGmoI6aiSvEQ2PV5Esd2oHz2SUpMJGc72biW2wS4a3/pub?gid=0&single=true&output=csv';
    
    // UPDATED: The URL is now wrapped in a CORS proxy to prevent loading errors.
    const GOOGLE_SHEET_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(originalUrl)}`;

    const loadingDiv = document.getElementById('loading');
    const storeListContainer = document.getElementById('store-list');
    const searchInput = document.getElementById('search-input');
    const categoryFiltersContainer = document.getElementById('category-filters');
    const floorFiltersContainer = document.getElementById('floor-filters');
    const noResultsDiv = document.getElementById('no-results');
    
    let stores = []; // This will hold our store data once fetched.

    // --- 2. DATA FETCHING AND PROCESSING ---
    
    const convertGoogleDriveUrl = (url) => {
        if (!url || !url.includes('drive.google.com/file/d/')) return null;
        const fileIdMatch = url.match(/file\/d\/([^/]+)/);
        if (fileIdMatch && fileIdMatch[1]) {
            return `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}`;
        }
        return null;
    };

    const getConsolidatedCategory = (originalCategory = '') => {
        const cat = originalCategory.toLowerCase();
        if (cat.includes('food') || cat.includes('beverage') || cat.includes('restaurant') || cat.includes('cafe') || cat.includes('bakery') || cat.includes('yogurt') || cat.includes('coffee')) return 'Food & Beverage';
        if (cat.includes('apparel') || cat.includes('fashion') || cat.includes('clothing') || cat.includes('thrift') || cat.includes('lingerie') || cat.includes('boutique') || cat.includes('k-pop')) return 'Fashion & Apparel';
        if (cat.includes('health') || cat.includes('pharmacy') || cat.includes('beauty') || cat.includes('cosmetics') || cat.includes('skincare') || cat.includes('optical') || cat.includes('eyecare') || cat.includes('fitness') || cat.includes('salon')) return 'Health, Beauty & Wellness';
        if (cat.includes('electronics') || cat.includes('telecommunications') || cat.includes('mobile') || cat.includes('appliances') || cat.includes('gaming') || cat.includes('photography')) return 'Electronics & Appliances';
        if (cat.includes('home') || cat.includes('furnishings') || cat.includes('decor') || cat.includes('hardware') || cat.includes('carpet')) return 'Home & Living';
        if (cat.includes('jewelry') || cat.includes('jewellery') || cat.includes('golf') || cat.includes('pet') || cat.includes('bookstore') || cat.includes('outdoor') || cat.includes('gift') || cat.includes('tobacco')) return 'Specialty & Hobby Retail';
        if (cat.includes('financial') || cat.includes('laundry') || cat.includes('tailoring') || cat.includes('e-commerce') || cat.includes('services') || cat.includes('bank')) return 'Services';
        return 'Miscellaneous';
    };

    const parseCSV = (data) => {
        const lines = data.trim().split('\n').slice(1);
        return lines.map(line => {
            const regex = /(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^\",]+))/g;
            let match;
            const values = [];
            while(match = regex.exec(line)) {
                values.push(match[1] ? match[1].replace(/\"\"/g, '\"') : match[2]);
            }
            if (values.length >= 4) {
                 return {
                    name: values[0],
                    location: `${values[2]} | Lot: ${values[1]}`,
                    floor: values[2],
                    category: getConsolidatedCategory(values[3]),
                    originalCategory: values[3],
                    image: convertGoogleDriveUrl(values[4]) 
                };
            }
            return null;
        }).filter(store => store !== null);
    };
    
    // --- 3. DYNAMIC HTML GENERATION & LOGIC ---

    const displayStores = (filteredStores) => {
        storeListContainer.innerHTML = '';
        noResultsDiv.classList.toggle('hidden', filteredStores.length > 0);
        storeListContainer.classList.toggle('hidden', filteredStores.length === 0);

        const placeholderImg = 'https://placehold.co/600x400/E2E8F0/4A5568?text=No+Image';

        filteredStores.forEach(store => {
            const storeCard = document.createElement('div');
            storeCard.className = 'store-card bg-white rounded-lg shadow-md flex flex-col transition-transform transform hover:-translate-y-1 hover:shadow-xl overflow-hidden';
            
            storeCard.innerHTML = `
                <div class="aspect-square bg-gray-200">
                    <img src="${store.image || placeholderImg}" 
                         onerror="this.onerror=null; this.src='${placeholderImg}';"
                         alt="Image of ${store.name}" 
                         class="w-full h-full object-cover">
                </div>
                <div class="p-4 flex-grow flex flex-col">
                    <div class="flex-grow">
                        <h3 class="text-lg font-bold text-gray-800 leading-tight">${store.name}</h3>
                        <p class="text-red-600 font-semibold my-1 text-sm">${store.location}</p>
                    </div>
                    <div class="mt-3">
                        <span class="category text-xs font-medium bg-gray-200 text-gray-700 py-1 px-2 rounded-full">${store.category}</span>
                    </div>
                </div>
            `;
            storeListContainer.appendChild(storeCard);
        });
    };

    const setupFloorFilters = () => {
        const floors = ['All Floors', ...new Set(stores.map(store => store.floor))];
        floorFiltersContainer.innerHTML = '<span class="font-semibold text-gray-600 mr-2 shrink-0">Floor:</span>'; // Reset
        floors.forEach(floor => {
            const button = document.createElement('button');
            button.innerText = floor;
            button.dataset.floor = floor;
            button.className = 'filter-btn px-4 py-2 text-sm sm:text-base font-medium border border-blue-600 text-blue-600 rounded-full hover:bg-blue-100 transition-colors';
            if (floor === 'All Floors') button.classList.add('active');
            floorFiltersContainer.appendChild(button);
        });
    };

    const setupCategoryFilters = () => {
        const categories = ['All', ...new Set(stores.map(store => store.category))].sort();
        categoryFiltersContainer.innerHTML = '<span class="font-semibold text-gray-600 mr-2 shrink-0">Category:</span>'; // Reset
        categories.forEach(category => {
            const button = document.createElement('button');
            button.innerText = category;
            button.dataset.category = category;
            button.className = 'filter-btn px-4 py-2 text-sm sm:text-base font-medium border border-blue-600 text-blue-600 rounded-full hover:bg-blue-100 transition-colors';
            if (category === 'All') button.classList.add('active');
            categoryFiltersContainer.appendChild(button);
        });
    };

    const filterAndDisplay = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const activeCategory = document.querySelector('#category-filters button.active').dataset.category;
        const activeFloor = document.querySelector('#floor-filters button.active').dataset.floor;

        let filteredStores = stores;

        if (activeFloor !== 'All Floors') {
            filteredStores = filteredStores.filter(store => store.floor === activeFloor);
        }
        if (activeCategory !== 'All') {
            filteredStores = filteredStores.filter(store => store.category === activeCategory);
        }
        if (searchTerm) {
            filteredStores = filteredStores.filter(store => 
                store.name.toLowerCase().includes(searchTerm) ||
                store.location.toLowerCase().includes(searchTerm) ||
                store.category.toLowerCase().includes(searchTerm) ||
                store.originalCategory.toLowerCase().includes(searchTerm)
            );
        }
        displayStores(filteredStores);
    };

    // --- 4. INITIALIZATION ---
    
    async function initializeApp() {
        if (!originalUrl) {
            loadingDiv.innerText = 'Error: The Google Sheet URL is missing.';
            loadingDiv.classList.add('text-red-500');
            return;
        }

        try {
            const response = await fetch(GOOGLE_SHEET_URL);
            if (!response.ok) throw new Error('Network response was not ok.');
            const csvData = await response.text();
            
            stores = parseCSV(csvData);

            // Hide loading and show the list
            loadingDiv.classList.add('hidden');
            storeListContainer.classList.remove('hidden');

            // Setup filters and display stores
            setupFloorFilters();
            setupCategoryFilters();
            displayStores(stores);

            // Add event listeners now that we have data
            searchInput.addEventListener('input', filterAndDisplay);
            floorFiltersContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#floor-filters button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    filterAndDisplay();
                }
            });
            categoryFiltersContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#category-filters button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    filterAndDisplay();
                }
            });

        } catch (error) {
            console.error('Failed to fetch or process sheet data:', error);
            loadingDiv.innerText = 'Error: Could not load data from the Google Sheet. Please check the URL and that it is published correctly.';
            loadingDiv.classList.add('text-red-500');
        }
    }

    initializeApp();
});
</script>

</body>
</html>

